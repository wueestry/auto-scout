"""Standard penetration testing workflow."""

import logging

from auto_scout.core.workflow import Workflow
from auto_scout.scans.nmap import DetailedNmapScan, QuickNmapScan, VulnNmapScan

logger = logging.getLogger(__name__)


class PentestWorkflow(Workflow):
    """
    Standard penetration testing workflow with conditional logic.

    Workflow stages:
    1. Quick port discovery (all ports)
    2. Detailed service detection (on found ports, parallel if needed)
    3. Vulnerability scanning (conditional on port count)
    """

    async def define(self) -> None:
        """Define the pentest workflow logic."""
        logger.info("=" * 60)
        logger.info("Starting Penetration Test Workflow")
        logger.info(f"Target: {self.context.target_ip}")
        logger.info("=" * 60)

        # Stage 1: Quick port discovery
        logger.info("\n[Stage 1/3] Quick Port Discovery")
        logger.info("-" * 60)
        quick_scan = QuickNmapScan()
        await self.execute_scan(quick_scan)

        # Check if we found any open ports
        if not self.context.has_open_ports():
            logger.warning("No open ports found. Workflow complete.")
            return

        open_ports = self.context.get_open_ports()
        logger.info(f"Found {len(open_ports)} open ports")

        # Stage 2: Detailed service detection
        logger.info("\n[Stage 2/3] Detailed Service Detection")
        logger.info("-" * 60)
        detailed_scan = DetailedNmapScan()
        await self.execute_scan(detailed_scan)

        # Stage 3: Vulnerability scanning (conditional)
        logger.info("\n[Stage 3/3] Vulnerability Assessment")
        logger.info("-" * 60)

        # Only run vuln scan if we have enough ports or services
        port_count = len(self.context.get_open_ports())
        services = self.context.get_services()

        if port_count >= 3 or len(services) >= 2:
            logger.info(f"Running vulnerability scan on {port_count} ports...")
            vuln_scan = VulnNmapScan()
            await self.execute_scan(vuln_scan)
        else:
            logger.info(f"Skipping vulnerability scan (only {port_count} ports found)")

        # Workflow complete
        logger.info("\n" + "=" * 60)
        logger.info("Penetration Test Workflow Complete")
        logger.info("=" * 60)
        self._print_summary()

    def _print_summary(self) -> None:
        """Print a summary of the scan results."""
        successful = self.context.get_successful_results()
        logger.info(f"\nCompleted {len(successful)} successful scans:")

        for scan_name, result in successful.items():
            logger.info(f"  - {scan_name}: {result.duration:.2f}s")

        open_ports = self.context.get_open_ports()
        if open_ports:
            logger.info(f"\nOpen ports: {', '.join(map(str, open_ports))}")

        services = self.context.get_services()
        if services:
            logger.info("\nDetected services:")
            for port, service in sorted(services.items()):
                logger.info(f"  - {port}/{service}")
